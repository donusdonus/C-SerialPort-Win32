
cmake_minimum_required(VERSION 3.14)
project(SerialPort_Win32)

        
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_C_STANDARD 11)
set(CMAKE_BUILD_TYPE Debug)

include(FetchContent)
#------------------------- FreeRTOS --------------------------------
# FreeRTOSConfig.h
add_library(freertos_config INTERFACE)
target_include_directories(freertos_config INTERFACE
  ${CMAKE_CURRENT_SOURCE_DIR}
)

# FreeRTOS Kernel
FetchContent_Declare(
  freertos
  GIT_REPOSITORY https://github.com/FreeRTOS/FreeRTOS-Kernel.git
  GIT_TAG        main
  UPDATE_DISCONNECTED TRUE
)
FetchContent_MakeAvailable(freertos)


#--------------------------------------------------------------------


if(MINGW)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -m32")
    set(CMAKE_CX_FLAGS "${CMAKE_C_FLAGS} -m32")
endif()



add_subdirectory(lib)

add_executable(app
src/main.cpp
)

# FreeRTOS Kernel source
target_sources(app PRIVATE
  ${freertos_SOURCE_DIR}/list.c
  ${freertos_SOURCE_DIR}/queue.c
  ${freertos_SOURCE_DIR}/tasks.c
  ${freertos_SOURCE_DIR}/timers.c
  ${freertos_SOURCE_DIR}/event_groups.c
  ${freertos_SOURCE_DIR}/portable/MemMang/heap_4.c
  ${freertos_SOURCE_DIR}/portable/MSVC-MingW/port.c
)

target_include_directories(app PRIVATE
  ${freertos_SOURCE_DIR}/include
  ${freertos_SOURCE_DIR}/portable/MSVC-MingW
  ${CMAKE_CURRENT_SOURCE_DIR}
)

target_link_libraries(app 
PRIVATE
SerialPort_Win32
freertos_kernel           
freertos_config           
)

        


option(ENABLE_STATIC_ANALYSIS "Enable static analysis targets" ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

if(ENABLE_STATIC_ANALYSIS)
  find_program(CPPCHECK_EXE NAMES cppcheck)
  find_program(CLANG_TIDY_EXE NAMES clang-tidy)

  # ---- clang-tidy: ตรวจเฉพาะ SerialPort_Win32 ----
  if(CLANG_TIDY_EXE)
    add_custom_target(analyze-serial-tidy
      COMMAND ${CMAKE_COMMAND} -E echo "== clang-tidy: SerialPort_Win32 =="
      COMMAND ${CLANG_TIDY_EXE}
              -p ${CMAKE_BINARY_DIR}
              -checks=-*,clang-analyzer-*,bugprone-*,performance-*,readability-*
              --warnings-as-errors=*
              --header-filter=${CMAKE_SOURCE_DIR}/lib/SerialPort_Win32/.*
              ${CMAKE_SOURCE_DIR}/lib/SerialPort_Win32/SerialPort_Win32.cpp
      VERBATIM
    )
  endif()

  # ---- cppcheck: ตรวจเฉพาะ SerialPort_Win32 ----
  if(CPPCHECK_EXE)
    add_custom_target(analyze-serial-cppcheck
      COMMAND ${CMAKE_COMMAND} -E echo "== cppcheck: SerialPort_Win32 =="
      COMMAND ${CPPCHECK_EXE}
              --enable=all --inconclusive --force --inline-suppr
              --std=c++11 --language=c++ --error-exitcode=1
              --suppress=missingIncludeSystem
              --template=gcc
              -I ${CMAKE_SOURCE_DIR}/lib/SerialPort_Win32
              ${CMAKE_SOURCE_DIR}/lib/SerialPort_Win32/SerialPort_Win32.cpp
      VERBATIM
    )
  endif()

  add_custom_target(analyze-serial
    DEPENDS analyze-serial-tidy analyze-serial-cppcheck
  )
endif()